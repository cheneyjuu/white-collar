(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/race/raceMap"],{"1f95":function(e,t,n){"use strict";(function(e){n("18a1");o(n("66fd"));var t=o(n("6046"));function o(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},"332c":function(e,t,n){},"35ca":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=a(n("277c"));function r(){if("function"!==typeof WeakMap)return null;var e=new WeakMap;return r=function(){return e},e}function a(e){if(e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var t=r();if(t&&t.has(e))return t.get(e);var n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){var c=o?Object.getOwnPropertyDescriptor(e,a):null;c&&(c.get||c.set)?Object.defineProperty(n,a,c):n[a]=e[a]}return n.default=e,t&&t.set(e,n),n}var c=function(){n.e("components/uni-steps/uni-steps").then(function(){return resolve(n("5c71"))}.bind(null,n)).catch(n.oe)},i={components:{uniSteps:c},data:function(){return{raceId:"",itemId:"",lng:0,lat:0,isStart:!1,raceInterval:null,markers:[],polyline:[{points:[],color:"#12aa9cDD",width:2,dottedLine:!1}],enableScroll:!0,nums:"00:00:00",timer:null,myInterval:null,speed:0,covers:[],meters:0,info:"",minute:0,hour:0,oriMeters:0,showMeters:0,pointTitles:[],scroll:-1,currentPoint:{},currentIndex:0,currentPointStr:null,showDialog:!1,checkinIndexList:[],data:[],modalName:null,complete:!1,raceInfo:e.getStorageSync("raceInfo")?e.getStorageSync("raceInfo"):{itemId:null,index:0,complete:!1},isDebug:!1}},methods:{regionchange:function(e){},markertap:function(e){},controltap:function(e){},loadRouteData:function(t){var n=this,r=e.getStorageSync("id_token");e.getStorageSync("userInfo");e.request({url:"".concat(o.baseUrl,"/races/items/").concat(t,"/routes"),method:"GET",header:{"content-type":"application/json",Authorization:"Bearer "+r},success:function(e){var t=e.data.data;t.checkInInfoList;n.raceInfo.index>0&&n.raceInfo.itemId===n.itemId&&(n.currentIndex=n.raceInfo.index,n.scroll=n.currentIndex-1),n.data=t,n.data.forEach((function(e,t){n.pointTitles.push(e.title);var o="/static/map/".concat(t+1,".png"),r={iconPath:o,id:t,longitude:e.lng,latitude:e.lat,width:32,height:32};n.markers.push(r)})),n.currentPoint=n.data[n.currentIndex],n.myInterval=setInterval((function(){var e=n.currentPoint,t=e.lng,o=e.lat;wx.getLocation({type:"gcj02",success:function(e){var r,a;n.isDebug?(r=31.493672,a=120.488069):(r=e.latitude,a=e.longitude);var c=e.speed;c>0&&(n.speed=c.toFixed(2));var i={longitude:a,latitude:r};n.drawline(i),n.currentPointStr=r+","+a;var l=n.getDistance(r,a,o,t),s=n.currentIndex;console.log(l,s,-1===n.checkinIndexList.findIndex((function(e){return e===s}))),l<=150&&-1===n.checkinIndexList.findIndex((function(e){return e===s}))&&(n.enableScroll=!1,n.showDialog=!0,n.lng=t,n.lat=o)}})}),2e3)},fail:function(){},complete:function(){}})},checkin:function(){var t=this,n=e.getStorageSync("id_token"),r=(e.getStorageSync("userInfo"),t.itemId);t.countTime(),t.checkinIndexList.push(t.currentIndex),t.scroll=t.currentIndex;var a={itemId:{id:r},title:t.currentPoint.title,checkInPoint:t.currentPointStr,spendTime:t.nums};if(e.request({url:"".concat(o.baseUrl,"/races/items/routes/checkin"),method:"POST",header:{"content-type":"application/json",Authorization:"Bearer "+n},data:a,success:function(n){var o=n.data.data;console.log(o),e.setStorageSync("checkinIndexList",t.checkinIndexList)},fail:function(){},complete:function(){}}),t.currentIndex===t.data.length-1)return t.modalName="DialogModal1",t.complete=!0,t.showDialog=!1,t.enableScroll=!0,t.raceInfo.itemId=t.itemId,t.raceInfo.complete=!0,t.raceInfo.index=0,e.setStorageSync("raceInfo",t.raceInfo),clearInterval(t.myInterval),void clearInterval(t.timer);t.raceInfo.index=parseInt(t.raceInfo.index,10)+1,e.setStorageSync("raceInfo",t.raceInfo),t.currentIndex+=1,console.log("currentIndex",t.currentIndex),t.showDialog=!1,t.enableScroll=!0,t.currentPoint=t.data[t.currentIndex]},hideModal:function(e){this.modalName=null},completeRace:function(){this.modalName=null,e.removeStorageSync("raceInfo"),e.navigateBack({delta:1})},getDistance:function(e,t,n,o){var r=0,a=s(e),c=s(n),i=a-c,l=s(t)-s(o);r=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(a)*Math.cos(c)*Math.pow(Math.sin(l/2),2)));return 6378137*r;function s(e){return e*Math.PI/180}},countTime:function(){var e,t,n,o=this;e=t=n=0;var r=0;o.timer=setInterval((function(){r+=50,r>=1e3&&(r=0,n+=1),n>=60&&(n=0,t+=1,o.minute=t),t>=60&&(t=0,e+=1,o.hour=e),o.nums=e+":"+t+":"+n}),50)},startRace:function(){var e=this;this.polyline[0].points=[],e.raceInterval=setInterval((function(){wx.getLocation({type:"gcj02",success:function(t){console.log(t);var n=t.latitude,o=t.longitude,r=t.speed;r>0&&(e.speed=r.toFixed(2));var a,c={longitude:o,latitude:n},i={latitude:t.latitude,longitude:t.longitude,iconPath:"/static/location.png"},l=e.covers,s=l.length;0==s&&l.push(i),s=l.length,a=l[s-1],console.log("oriCovers----------"),console.log(l,s);var u=e.getDistance(a.latitude,a.longitude,t.latitude,t.longitude)/1e3;u<.0015&&(u=0),e.oriMeters=e.oriMeters+u,console.log("newMeters----------"),console.log(u),console.log("oriMeters:",e.oriMeters);var d=new Number(e.oriMeters),f=d.toFixed(2);console.log("showMeters:",f),e.meters=f,l.push(i),e.drawline(c)}}),console.log(e.polyline[0])}),2e3),e.isStart=!0,e.countTime()},drawline:function(e){this.polyline[0].points.push(e)},endRace:function(){var t=e.getStorageSync("id_token");clearInterval(this.raceInterval),clearInterval(this.timer),this.isStart=!1;var n={points:this.polyline[0].points,raceId:{id:this.raceId},itemId:{id:this.itemId},spendTime:this.nums,score:this.meters};e.request({url:"".concat(o.baseUrl,"/races/items/scores"),method:"PUT",data:n,header:{"content-type":"application/json",Authorization:"Bearer "+t},success:function(e){var t=e.data.data;console.log(t)},fail:function(){},complete:function(){}})},mapUpdate:function(){wx.startLocationUpdate({success:function(t){e.showToast({icon:"none",title:JSON.stringify(t)})},complete:function(e){console.log("获取位置"),console.log(e)}})}},onLoad:function(t){this.raceId=t.raceId,this.itemId=t.itemId;var n=e.getStorageSync("raceInfo");console.log("race info"),console.log(n),n||(this.raceInfo.itemId=t.itemId);var o=this;wx.startLocationUpdateBackground({success:function(e){console.log(e)}}),o.isDebug?(this.lng=120.488069,this.lat=31.493672):wx.getLocation({type:"gcj02",isHighAccuracy:!0,success:function(e){console.log(e),o.lat=e.latitude,o.lng=e.longitude}}),this.loadRouteData(this.itemId)},onUnload:function(){clearInterval(this.myInterval),clearInterval(this.timer)}};t.default=i}).call(this,n("543d")["default"])},"58f5":function(e,t,n){"use strict";var o=n("332c"),r=n.n(o);r.a},6046:function(e,t,n){"use strict";n.r(t);var o=n("73a7"),r=n("6d24");for(var a in r)"default"!==a&&function(e){n.d(t,e,(function(){return r[e]}))}(a);n("58f5");var c,i=n("f0c5"),l=Object(i["a"])(r["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],c);t["default"]=l.exports},"6d24":function(e,t,n){"use strict";n.r(t);var o=n("35ca"),r=n.n(o);for(var a in o)"default"!==a&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t["default"]=r.a},"73a7":function(e,t,n){"use strict";var o,r=function(){var e=this,t=e.$createElement;e._self._c},a=[];n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return o}))}},[["1f95","common/runtime","common/vendor"]]]);