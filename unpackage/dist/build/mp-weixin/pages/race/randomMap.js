(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/race/randomMap"],{"1dfc":function(e,t,n){},2720:function(e,t,n){"use strict";n.r(t);var o=n("ec27"),a=n("3a34");for(var c in a)"default"!==c&&function(e){n.d(t,e,(function(){return a[e]}))}(c);n("a6bd");var i,r=n("f0c5"),s=Object(r["a"])(a["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],i);t["default"]=s.exports},"3a34":function(e,t,n){"use strict";n.r(t);var o=n("70cd"),a=n.n(o);for(var c in o)"default"!==c&&function(e){n.d(t,e,(function(){return o[e]}))}(c);t["default"]=a.a},"70cd":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=c(n("277c"));function a(){if("function"!==typeof WeakMap)return null;var e=new WeakMap;return a=function(){return e},e}function c(e){if(e&&e.__esModule)return e;if(null===e||"object"!==typeof e&&"function"!==typeof e)return{default:e};var t=a();if(t&&t.has(e))return t.get(e);var n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var c in e)if(Object.prototype.hasOwnProperty.call(e,c)){var i=o?Object.getOwnPropertyDescriptor(e,c):null;i&&(i.get||i.set)?Object.defineProperty(n,c,i):n[c]=e[c]}return n.default=e,t&&t.set(e,n),n}var i=function(){n.e("components/uni-steps/uni-steps").then(function(){return resolve(n("5c71"))}.bind(null,n)).catch(n.oe)},r={components:{uniSteps:i},data:function(){return{raceId:"",itemId:"",lng:0,lat:0,isStart:!1,raceInterval:null,markers:[],polyline:[{points:[],color:"#12aa9cDD",width:2,dottedLine:!1}],enableScroll:!0,nums:"00:00:00",timer:null,myInterval:null,speed:0,covers:[],meters:0,info:"",minute:0,hour:0,oriMeters:0,showMeters:0,pointTitles:[],scroll:-1,currentPoint:{},currentIndex:0,currentPointStr:null,showDialog:!1,checkinIndexList:[],data:[],modalName:null,complete:!1,raceInfo:e.getStorageSync("raceInfo")?e.getStorageSync("raceInfo"):{itemId:null,index:0,complete:!1},userCheckedIndexList:[],isDebug:!1}},methods:{regionchange:function(e){},markertap:function(e){},controltap:function(e){},loadRouteData:function(t){var n=this,a=e.getStorageSync("id_token");e.getStorageSync("userInfo");e.request({url:"".concat(o.baseUrl,"/races/items/").concat(t,"/routes"),method:"GET",header:{"content-type":"application/json",Authorization:"Bearer "+a},success:function(e){var t=e.data.data;n.data=t,n.data.forEach((function(e,t){n.pointTitles.push({title:e.title,checked:!1});var o="/static/map/".concat(t+1,".png"),a={iconPath:o,id:t,longitude:e.lng,latitude:e.lat,width:32,height:32};n.markers.push(a)})),n.raceInfo.itemId===n.itemId&&n.userCheckedIndexList&&n.userCheckedIndexList.forEach((function(e){n.pointTitles[e].checked=!0})),n.myInterval=setInterval((function(){wx.getLocation({type:"gcj02",success:function(e){var t,o;n.isDebug?(t=31.493489,o=120.487983):(t=e.latitude,o=e.longitude),n.data.forEach((function(e,a){if(n.userCheckedIndexList.forEach((function(t){t===a&&(e.isChecked=!0)})),!e.isChecked){var c=e.lat,i=e.lng,r=n.getDistance(t,o,c,i);if(r<=100){n.currentPoint=e,console.log("currentIndex",a),n.currentIndex=a,n.showDialog=!0;var s=n.userCheckedIndexList.find((function(e){return e===a}));s||(n.userCheckedIndexList.push(a),console.log("用户已签到数据"),console.log(n.userCheckedIndexList))}}}))}})}),2e3)},fail:function(){},complete:function(){}})},checkin:function(){var t=this,n=e.getStorageSync("id_token"),a=(e.getStorageSync("userInfo"),t.itemId);t.countTime();var c=t.data[t.currentIndex],i=c.latitude+","+c.longitude;console.log("checkInPoint",i);var r={itemId:{id:a},title:c.title,checkInPoint:i,spendTime:t.nums};if(e.request({url:"".concat(o.baseUrl,"/races/items/routes/checkin"),method:"POST",header:{"content-type":"application/json",Authorization:"Bearer "+n},data:r,success:function(n){n.data.data;c.isChecked=!0,t.userCheckedIndexList.forEach((function(e){t.pointTitles[e].checked=!0})),e.setStorageSync("userCheckedIndexList",t.userCheckedIndexList)},fail:function(){},complete:function(){}}),t.userCheckedIndexList.length===t.data.length)return t.modalName="DialogModal1",t.complete=!0,t.showDialog=!1,t.enableScroll=!0,t.raceInfo.itemId=t.itemId,t.raceInfo.complete=!0,t.raceInfo.index=0,e.setStorageSync("raceInfo",t.raceInfo),clearInterval(t.myInterval),void clearInterval(t.timer);t.raceInfo.index=parseInt(t.raceInfo.index,10)+1,e.setStorageSync("raceInfo",t.raceInfo),t.showDialog=!1,t.enableScroll=!0},hideModal:function(e){this.modalName=null},completeRace:function(){this.modalName=null,e.removeStorageSync("raceInfo"),e.removeStorageSync("userCheckedIndexList"),e.navigateBack({delta:1})},getDistance:function(e,t,n,o){var a=0,c=u(e),i=u(n),r=c-i,s=u(t)-u(o);a=2*Math.asin(Math.sqrt(Math.pow(Math.sin(r/2),2)+Math.cos(c)*Math.cos(i)*Math.pow(Math.sin(s/2),2)));return 6378137*a;function u(e){return e*Math.PI/180}},countTime:function(){var e,t,n,o=this;e=t=n=0;var a=0;o.timer=setInterval((function(){a+=50,a>=1e3&&(a=0,n+=1),n>=60&&(n=0,t+=1,o.minute=t),t>=60&&(t=0,e+=1,o.hour=e),o.nums=e+":"+t+":"+n}),50)},startRace:function(){var e=this;this.polyline[0].points=[],e.raceInterval=setInterval((function(){wx.getLocation({type:"gcj02",success:function(t){console.log(t);var n,o=t.latitude,a=t.longitude,c={latitude:o,longitude:a},i=e.covers,r=i.length;0==r&&i.push(c),r=i.length,n=i[r-1];var s=e.getDistance(n.latitude,n.longitude,t.latitude,t.longitude)/1e3;s<.0015&&(s=0),i.push(c),e.drawline(c)}}),console.log(e.polyline[0])}),2e3),e.isStart=!0,e.countTime()},drawline:function(e){this.polyline[0].points.push(e)},endRace:function(){var t=e.getStorageSync("id_token");clearInterval(this.raceInterval),clearInterval(this.timer),this.isStart=!1;var n={points:this.polyline[0].points,raceId:{id:this.raceId},itemId:{id:this.itemId},spendTime:this.nums,score:this.meters};e.request({url:"".concat(o.baseUrl,"/races/items/scores"),method:"PUT",data:n,header:{"content-type":"application/json",Authorization:"Bearer "+t},success:function(e){var t=e.data.data;console.log(t)},fail:function(){},complete:function(){}})},mapUpdate:function(){wx.startLocationUpdate({success:function(t){e.showToast({icon:"none",title:JSON.stringify(t)})},complete:function(e){console.log("获取位置"),console.log(e)}})}},onLoad:function(t){this.raceId=t.raceId,this.itemId=t.itemId;var n=e.getStorageSync("raceInfo");console.log("race info"),console.log(n),n||(this.raceInfo.itemId=t.itemId);var o=this,a=e.getStorageSync("userCheckedIndexList");a&&(o.userCheckedIndexList=a),wx.startLocationUpdateBackground({success:function(e){console.log(e)}}),o.isDebug?(this.lng=120.488069,this.lat=31.493672):wx.getLocation({type:"gcj02",isHighAccuracy:!0,success:function(e){console.log(e),o.lat=e.latitude,o.lng=e.longitude}}),this.loadRouteData(this.itemId)},onUnload:function(){clearInterval(this.myInterval),clearInterval(this.timer)}};t.default=r}).call(this,n("543d")["default"])},a6bd:function(e,t,n){"use strict";var o=n("1dfc"),a=n.n(o);a.a},ec27:function(e,t,n){"use strict";var o,a=function(){var e=this,t=e.$createElement;e._self._c},c=[];n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return c})),n.d(t,"a",(function(){return o}))},ff56:function(e,t,n){"use strict";(function(e){n("18a1");o(n("66fd"));var t=o(n("2720"));function o(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])}},[["ff56","common/runtime","common/vendor"]]]);